# (debugging)

## kubectl-debug

Под "дебагом" подразумевается мероприятия (операции) с целью выявления проблем внутри диагностируемого контейнера с помощью дополнительных инструментов. Но в связи с тем, что на практике образ контейнера не содержит ничего лишнего (даже пакетного менеджера) кроме файлов для функционирования целевого приложения, в нём нет инструментов (утилит) для диагностики.  

В настоящий момент начиная с версии k8s 1.25 существует встроенная в kubectl возможность "дебага" c помощью команды `kubectl debug`, которая по сути создает т.н. эфемерный контейнер с необходимым образом внутри работающего пода (рядом с отлаживаемым контейнером). Таким образом появляется возможность использования необходимыэ для отладки инструментов. Например в данном случаев для пода с MySql используется образ для отладки сети (curl, nslookup, tracert, tcpdump и пр.):
```
kubectl debug -it mysql-instance-765549d488-z2vzx --image=wbitt/network-multitool -- sh
```
При этом в поде создастся эфемерный контейнер со всем доступным в выбранном образе инструментарием, и будет запущен shell в присоединенном интерактивном терминале. Этот новый контейнер будет работать до завершения запущенного процесса (shell). 

Существуют дополнительные опции запуска дебаг-контейнера:
- `--target [container_name]` - эфемерному контейнеру в том же поде будет предоставлен pid-неймспейс целевого контейнера (требует поддержки со стороны Container Runtime)
- `--copy-to` - создаётся копия целевого пода c дополнительным контейнером (уже side-car) со своим образом
- `--share-processes` - используется вместе с `--copy-to`, включает в поде единый pid-неймспейс (через shareProcessNamespace: true)

## iptables-tailer

Иногда при использовании сетевых политик (NetworkPolicy), работающих на сетевом и транспортном (3-4) уровнях, возникает необходимость быстро понимать причину "непрохождения" трафика. Одним из решений является запись в журнал событий k8s всех случаев "отбрасывания" пакетов iptables c помощью 

[*]
- Исправьте ошибку в нашей сетевой политике, чтобы Netperf снова начал
работать
- Поправьте манифест DaemonSet из репозитория, чтобы в логах
отображались имена Podов, а не их IP-адреса